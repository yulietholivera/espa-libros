import{a as o,o as E}from"./chunk-QMGIS6GS-ClXNqF_9.js";import{b as c}from"./auth-BPhwfanI.js";const m=o.createContext(void 0),d=n=>n?n.map(t=>!t.libroId||!t.libroId._id?(console.warn("Item de carrito inválido recibido del backend:",t),null):{...t.libroId,_id:t.libroId._id,quantity:t.cantidad}).filter(t=>t!==null):[];function y({children:n}){const[t,s]=o.useState([]),[l,u]=o.useState(!0);o.useEffect(()=>{(async()=>{const e=c();if(!e){u(!1);return}try{const r=await fetch("/api/carrito",{headers:{Authorization:`Bearer ${e}`}});if(r.ok){const i=await r.json();s(d(i.items))}}catch(r){console.error("Error al cargar el carrito inicial:",r)}finally{u(!1)}})()},[]);const f=o.useCallback(async a=>{const e=c();if(!e){alert("Debes iniciar sesión para agregar al carrito.");return}try{const r=await fetch("/api/carrito",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({libroId:a._id,cantidad:1})}),i=await r.json();if(r.ok)s(d(i.items));else throw new Error(i.mensaje||"Error al añadir al carrito")}catch(r){console.error("Error en addToCart:",r)}},[]),C=o.useCallback(async a=>{const e=c();if(!(!e||!a))try{const r=await fetch(`/api/carrito/${a}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}}),i=await r.json();if(r.ok)s(d(i.items));else throw new Error(i.mensaje||"Error al eliminar del carrito")}catch(r){console.error("Error en removeFromCart:",r)}},[]),h=o.useCallback(()=>{s([])},[]),p=o.useMemo(()=>({cartItems:t,addToCart:f,removeFromCart:C,clearCart:h,totalItems:t.reduce((a,e)=>a+e.quantity,0),cartTotal:t.reduce((a,e)=>a+e.precio*e.quantity,0),isLoading:l}),[t,l,f,C,h]);return E.jsx(m.Provider,{value:p,children:n})}function I(){const n=o.useContext(m);if(n===void 0)throw new Error("useCart debe usarse dentro de un CartProvider");return n}export{y as C,I as u};
